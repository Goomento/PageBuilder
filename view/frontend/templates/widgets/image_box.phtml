<?php
/**
 * @package Goomento_PageBuilder
 * @link https://github.com/Goomento/PageBuilder
 */

declare(strict_types=1);

use Goomento\PageBuilder\Block\View\Element\Widget;
use Goomento\PageBuilder\Builder\Controls\Groups\ImageSizeGroup;
use Goomento\PageBuilder\Helper\DataHelper;
use Magento\Framework\Escaper;

/**
 * @var Widget $block
 * @var Escaper $escaper
 */
$widget = $block->getWidget();

$settings = $widget->getSettingsForDisplay();

$has_content = !DataHelper::isEmpty($settings['title_text']) || !DataHelper::isEmpty($settings['description_text']);

$html = '<div class="gmt-image-box-wrapper">';

if (!empty($settings['link']['url'])) {
    $widget->addRenderAttribute('link', 'href', $settings['link']['url']);

    if ($settings['link']['is_external']) {
        $widget->addRenderAttribute('link', 'target', '_blank');
    }

    if (!empty($settings['link']['nofollow'])) {
        $widget->addRenderAttribute('link', 'rel', 'nofollow');
    }
}

if (!empty($settings['image']['url'])) {
    $widget->addRenderAttribute('image', 'src', $settings['image']['url']);
    $widget->addRenderAttribute('image', 'alt', '');
    $widget->addRenderAttribute('image', 'title', '');

    if ($settings['hover_animation']) {
        $widget->addRenderAttribute('image', 'class', 'gmt-animation-' . $settings['hover_animation']);
    }

    $image_html = ImageSizeGroup::getAttachmentImageHtml($settings);

    if (!empty($settings['link']['url'])) {
        $image_html = '<a ' . $widget->getRenderAttributeString('link') . '>' . $image_html . '</a>';
    }

    $html .= '<figure class="gmt-image-box-img">' . $image_html . '</figure>';
}

if ($has_content) {
    $html .= '<div class="gmt-image-box-content">';

    if (!DataHelper::isEmpty($settings['title_text'])) {
        $widget->addRenderAttribute('title_text', 'class', 'gmt-image-box-title');

        $widget->addInlineEditingAttributes('title_text', 'none');

        $title_html = $settings['title_text'];

        if (!empty($settings['link']['url'])) {
            $title_html = '<a ' . $widget->getRenderAttributeString('link') . '>' . $title_html . '</a>';
        }

        $html .= sprintf('<%1$s %2$s>%3$s</%1$s>', $settings['title_size'], $widget->getRenderAttributeString('title_text'), $title_html);
    }

    if (!DataHelper::isEmpty($settings['description_text'])) {
        $widget->addRenderAttribute('description_text', 'class', 'gmt-image-box-description');

        $widget->addInlineEditingAttributes('description_text');

        $html .= sprintf('<p %1$s>%2$s</p>', $widget->getRenderAttributeString('description_text'), $settings['description_text']);
    }

    $html .= '</div>';
}

$html .= '</div>';

echo $html;
